#include "pwm_dac.h"

uint8_t xdata dac_buff1[256]; //播放缓存,最多缓存256*125=32ms,在32ms内必须填充好数据
uint8_t dac_read = 0;         //读缓存位置
uint8_t dac_write = 0;        //写缓存位置
uint8_t dac_sendflag = 0;     //正在发送数据标志位

/* Private define ------------------------------------------------------------*/
/* Quantizer step size lookup table */
code uint16_t StepSizeTable[89]={7,8,9,10,11,12,13,14,16,17,
                            19,21,23,25,28,31,34,37,41,45,
                            50,55,60,66,73,80,88,97,107,118,
                            130,143,157,173,190,209,230,253,279,307,
                            337,371,408,449,494,544,598,658,724,796,
                            876,963,1060,1166,1282,1411,1552,1707,1878,2066,
                            2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,
                            5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,
                            15289,16818,18500,20350,22385,24623,27086,29794,32767};
/* Table of index changes */
code int8_t IndexTable[16]={-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8};
/* wav data */
/*第0和第1字节为块开始时AD的数据,第三个字节为步进表index,后面252个字节为音频数据,每块为255个字节*/
code uint8_t wav_buf[] = {7, 0, 0,
95, 31, 80, 17, 157, 153, 96, 137, 188, 156, 96, 16, 107, 121,
82, 146, 222, 138, 49, 21, 176, 187, 24, 38, 129, 187, 154, 67,
2, 184, 170, 32, 36, 144, 171, 10, 33, 130, 25, 4, 132, 190,
139, 39, 144, 205, 58, 54, 148, 203, 154, 49, 3, 161, 187, 121,
18, 170, 172, 50, 37, 161, 219, 171, 50, 39, 129, 203, 11, 20,
128, 136, 168, 136, 17, 200, 56, 38, 202, 64, 19, 249, 219, 16,
52, 1, 201, 154, 130, 144, 9, 53, 19, 251, 11, 20, 176, 140,
68, 146, 174, 25, 34, 32, 152, 139, 18, 227, 155, 3, 2, 200,
19, 169, 23, 185, 143, 65, 18, 152, 190, 25, 52, 144, 152, 172,
67, 132, 233, 152, 50, 34, 200, 158, 34, 177, 200, 74, 84, 152,
187, 152, 37, 146, 155, 97, 160, 202, 32, 2, 40, 34, 234, 175,
32, 53, 192, 171, 65, 3, 202, 140, 98, 130, 202, 9, 51, 152,
170, 48, 19, 235, 25, 20, 170, 10, 50, 192, 128, 6, 200, 137,
49, 19, 236, 9, 35, 161, 28, 34, 241, 140, 65, 3, 201, 137,
21, 200, 138, 49, 145, 168, 8, 37, 153, 171, 81, 193, 9, 24,
162, 192, 4, 148, 10, 177, 241, 67, 132, 49, 160, 218, 40, 253,
159, 48, 161, 137, 83, 2, 65, 4, 187, 56, 164, 252, 155, 16,
153, 10, 83, 36, 3, 9, 48, 20, 177, 170, 189, 255, 138, 2,

181, 184, 75,
48, 38, 144, 152, 169, 72, 21, 152, 9, 216, 189, 8, 17, 80,
36, 176, 138, 152, 72, 84, 176, 138, 160, 204, 11, 49, 49, 38,
176, 11, 0, 9, 55, 146, 171, 171, 220, 140, 34, 67, 20, 186,
138, 0, 67, 21, 152, 154, 203, 156, 189, 82, 19, 48, 193, 157,
33, 17, 81, 160, 155, 160, 203, 188, 50, 39, 0, 153, 170, 32,
22, 17, 129, 203, 137, 202, 190, 34, 51, 37, 187, 155, 48, 54,
1, 0, 173, 8, 233, 202, 72, 33, 66, 216, 138, 16, 66, 130,
136, 152, 139, 186, 239, 16, 3, 65, 168, 155, 16, 52, 3, 152,
153, 171, 201, 239, 16, 32, 36, 153, 170, 58, 37, 49, 152, 140,
168, 169, 251, 45, 16, 114, 152, 152, 137, 36, 16, 2, 218, 128,
154, 219, 42, 2, 84, 160, 137, 137, 68, 17, 145, 170, 185, 176,
239, 16, 57, 36, 137, 208, 41, 34, 51, 138, 154, 158, 193, 188,
130, 80, 19, 128, 203, 17, 66, 6, 136, 169, 11, 201, 173, 130,
80, 35, 10, 218, 40, 36, 35, 184, 201, 170, 184, 175, 128, 98,
131, 129, 188, 131, 98, 131, 0, 173, 152, 138, 157, 145, 98, 2,
128, 140, 24, 98, 1, 161, 170, 185, 201, 30, 137, 21, 2, 129,
13, 8, 67, 1, 162, 157, 185, 186, 28, 41, 39, 16, 177, 26,
41, 39, 16, 192, 153, 156, 234, 129, 74, 18, 33, 170, 178, 96,

105, 29, 73,
49, 144, 170, 204, 201, 44, 28, 20, 33, 161, 136, 26, 21, 51,
160, 233, 156, 219, 24, 59, 6, 33, 168, 145, 90, 1, 5, 8,
217, 153, 172, 144, 107, 1, 34, 8, 176, 48, 0, 23, 0, 200,
201, 188, 192, 56, 48, 21, 40, 184, 33, 57, 135, 17, 154, 217,
188, 154, 43, 51, 69, 128, 162, 56, 41, 6, 32, 192, 184, 175,
139, 29, 129, 36, 32, 145, 32, 59, 18, 82, 9, 240, 186, 143,
169, 1, 50, 18, 149, 32, 26, 33, 88, 24, 168, 204, 189, 201,
25, 32, 22, 33, 8, 129, 32, 32, 131, 179, 204, 206, 171, 156,
16, 82, 49, 18, 17, 25, 163, 21, 24, 241, 169, 159, 186, 8,
72, 34, 19, 34, 40, 1, 3, 113, 10, 217, 203, 157, 156, 128,
66, 33, 132, 33, 25, 163, 4, 16, 137, 219, 251, 155, 142, 128,
34, 34, 132, 131, 2, 0, 130, 49, 45, 204, 187, 159, 155, 136,
66, 66, 18, 4, 16, 136, 163, 2, 42, 188, 237, 171, 142, 137,
50, 96, 1, 148, 130, 128, 0, 56, 26, 169, 251, 156, 142, 138,
1, 35, 20, 35, 48, 42, 144, 33, 74, 154, 250, 220, 217, 153,
24, 34, 51, 67, 17, 130, 17, 41, 146, 147, 173, 207, 172, 157,
168, 18, 82, 18, 132, 18, 0, 0, 56, 42, 184, 251, 188, 204,
155, 137, 35, 84, 49, 18, 2, 18, 24, 162, 181, 160, 173, 191,

71, 226, 68,
172, 153, 33, 113, 33, 33, 33, 0, 179, 132, 0, 168, 218, 188,
190, 203, 152, 17, 82, 65, 49, 18, 18, 32, 90, 59, 139, 234,
202, 235, 201, 160, 2, 65, 64, 33, 50, 48, 41, 144, 195, 152,
172, 205, 172, 157, 138, 129, 20, 36, 50, 19, 3, 1, 24, 8,
184, 204, 190, 205, 187, 154, 32, 114, 49, 49, 49, 49, 24, 129,
147, 160, 251, 235, 219, 202, 137, 74, 32, 4, 19, 34, 131, 132,
33, 58, 168, 217, 172, 174, 157, 140, 136, 131, 21, 49, 48, 18,
2, 147, 131, 8, 157, 204, 203, 158, 156, 153, 147, 6, 34, 49,
32, 18, 72, 41, 176, 212, 168, 171, 174, 188, 138, 41, 66, 51,
20, 20, 34, 72, 24, 128, 160, 186, 189, 205, 188, 187, 136, 66,
51, 37, 51, 34, 18, 3, 2, 152, 203, 236, 202, 189, 157, 154,
16, 51, 67, 36, 19, 19, 33, 32, 8, 170, 220, 203, 205, 188,
155, 9, 51, 53, 51, 51, 35, 35, 3, 19, 11, 190, 219, 189,
175, 172, 137, 32, 35, 21, 35, 50, 33, 18, 17, 144, 201, 187,
206, 205, 172, 139, 25, 50, 37, 35, 51, 50, 19, 19, 1, 169,
175, 219, 220, 187, 172, 25, 33, 36, 36, 50, 50, 50, 18, 3,
136, 203, 220, 236, 203, 187, 137, 48, 66, 67, 51, 51, 50, 49,
2, 2, 187, 221, 220, 189, 203, 154, 16, 66, 50, 36, 51, 34,

172, 29, 58,
2, 18, 0, 203, 251, 219, 188, 188, 138, 32, 36, 67, 35, 35,
34, 2, 18, 1, 168, 190, 205, 220, 202, 170, 24, 50, 67, 51,
36, 18, 18, 17, 18, 160, 234, 219, 220, 187, 173, 136, 49, 67,
50, 35, 35, 34, 34, 19, 129, 203, 191, 205, 188, 203, 137, 17,
67, 67, 34, 18, 34, 34, 34, 0, 201, 189, 205, 189, 188, 153,
32, 67, 67, 34, 34, 34, 49, 18, 1, 185, 237, 219, 204, 186,
155, 16, 52, 52, 34, 50, 34, 51, 35, 1, 201, 220, 204, 204,
202, 169, 8, 50, 52, 51, 50, 50, 36, 35, 17, 169, 251, 219,
204, 187, 187, 9, 49, 69, 35, 35, 35, 67, 34, 1, 152, 219,
188, 206, 203, 170, 153, 17, 67, 36, 36, 34, 34, 34, 16, 152,
186, 206, 188, 189, 171, 154, 8, 51, 69, 66, 50, 50, 34, 1,
144, 185, 189, 221, 187, 187, 171, 9, 33, 53, 52, 83, 51, 34,
18, 136, 160, 187, 190, 190, 187, 170, 154, 16, 33, 67, 68, 50,
52, 50, 18, 2, 186, 204, 219, 172, 169, 138, 152, 33, 17, 17,
99, 52, 18, 51, 1, 136, 200, 191, 171, 172, 137, 0, 8, 17,
65, 98, 34, 50, 34, 32, 132, 153, 216, 222, 169, 9, 184, 202,
9, 18, 3, 17, 39, 51, 38, 17, 34, 129, 186, 206, 173, 136,
160, 152, 16, 68, 146, 128, 33, 142, 33, 200, 8, 81, 160, 188,

133, 253, 37,
14, 145, 173, 99, 83, 113, 119, 232, 171, 49, 20, 169, 26, 34,
128, 201, 170, 40, 70, 130, 171, 10, 17, 176, 172, 32, 20, 129,
136, 137, 136, 24, 32, 68, 161, 154, 40, 144, 248, 255, 40, 52,
144, 187, 10, 33, 136, 48, 53, 146, 189, 24, 35, 203, 13, 33,
208, 188, 64, 52, 152, 139, 83, 131, 187, 57, 38, 144, 202, 206,
138, 17, 1, 16, 68, 129, 153, 16, 52, 1, 152, 168, 250, 191,
155, 40, 49, 68, 19, 160, 138, 33, 50, 84, 1, 250, 204, 171,
138, 65, 52, 34, 128, 153, 154, 65, 53, 3, 160, 254, 188, 9,
34, 35, 35, 129, 187, 156, 65, 67, 68, 129, 204, 189, 171, 49,
37, 2, 8, 136, 187, 9, 100, 35, 34, 216, 205, 171, 26, 83,
19, 128, 153, 153, 137, 49, 54, 51, 131, 237, 188, 155, 72, 37,
129, 152, 153, 153, 49, 66, 33, 50, 160, 238, 187, 171, 98, 36,
128, 155, 137, 136, 67, 19, 8, 80, 129, 220, 188, 139, 98, 35,
152, 171, 137, 33, 51, 18, 16, 115, 3, 221, 204, 138, 82, 34,
168, 170, 137, 50, 36, 129, 136, 96, 1, 235, 188, 154, 68, 19,
184, 155, 9, 65, 36, 128, 137, 49, 148, 233, 251, 154, 66, 19,
152, 171, 10, 49, 37, 145, 144, 51, 20, 188, 191, 172, 72, 37,
144, 155, 137, 56, 52, 144, 25, 67, 130, 218, 219, 173, 40, 53,

108, 42, 78,
169, 170, 8, 82, 18, 153, 32, 67, 145, 205, 186, 203, 49, 55,
168, 171, 25, 64, 50, 136, 25, 84, 129, 171, 219, 188, 26, 70,
129, 171, 10, 33, 34, 2, 128, 65, 6, 192, 185, 251, 154, 66,
20, 185, 155, 48, 49, 33, 16, 40, 100, 160, 140, 185, 207, 24,
37, 144, 171, 9, 50, 35, 137, 56, 53, 130, 218, 186, 206, 10,
99, 129, 185, 138, 49, 36, 128, 25, 67, 19, 202, 156, 217, 173,
56, 21, 160, 171, 16, 37, 129, 25, 51, 3, 160, 202, 236, 204,
25, 52, 144, 170, 8, 65, 34, 0, 64, 52, 176, 170, 209, 207,
139, 67, 129, 169, 136, 32, 50, 18, 48, 85, 0, 154, 168, 222,
156, 56, 35, 169, 155, 16, 83, 19, 9, 115, 4, 169, 8, 217,
189, 9, 34, 146, 170, 136, 67, 51, 40, 113, 83, 144, 10, 169,
207, 155, 49, 2, 169, 139, 51, 21, 130, 2, 39, 4, 184, 137,
250, 188, 24, 19, 144, 154, 41, 83, 17, 32, 67, 22, 145, 169,
184, 223, 154, 32, 2, 169, 137, 48, 38, 129, 64, 51, 19, 184,
202, 250, 190, 8, 2, 144, 137, 0, 98, 18, 24, 82, 50, 128,
155, 169, 255, 11, 16, 129, 169, 136, 34, 36, 130, 49, 54, 19,
152, 202, 250, 159, 0, 129, 136, 137, 16, 35, 33, 32, 115, 50,
145, 138, 251, 175, 24, 0, 8, 153, 9, 66, 3, 17, 52, 51,

206, 59, 61,
176, 186, 255, 155, 24, 0, 136, 154, 56, 20, 50, 52, 82, 83,
144, 154, 249, 173, 8, 128, 128, 160, 24, 51, 48, 115, 34, 82,
146, 154, 240, 235, 136, 8, 16, 136, 139, 49, 35, 52, 36, 82,
2, 171, 169, 239, 153, 144, 1, 162, 153, 16, 82, 35, 66, 51,
4, 144, 217, 175, 139, 137, 0, 144, 168, 17, 20, 99, 51, 98,
33, 168, 137, 237, 170, 136, 128, 129, 169, 9, 50, 98, 83, 35,
68, 144, 153, 250, 170, 137, 137, 8, 152, 10, 17, 66, 38, 36,
37, 19, 154, 217, 204, 153, 153, 25, 136, 9, 24, 34, 84, 52,
68, 35, 168, 153, 220, 187, 170, 154, 128, 25, 8, 2, 37, 39,
68, 50, 1, 178, 234, 203, 171, 139, 138, 0, 32, 129, 51, 55,
99, 67, 2, 130, 208, 219, 187, 186, 137, 8, 48, 48, 32, 68,
36, 69, 35, 131, 146, 251, 203, 187, 171, 137, 16, 64, 49, 18,
35, 55, 83, 4, 2, 152, 174, 188, 186, 186, 145, 2, 51, 98,
33, 34, 68, 51, 4, 147, 217, 220, 171, 172, 9, 25, 32, 132,
35, 64, 66, 82, 34, 131, 178, 219, 190, 203, 154, 9, 24, 49,
35, 65, 49, 23, 83, 32, 146, 177, 188, 205, 156, 138, 9, 24,
3, 3, 5, 49, 67, 68, 80, 8, 176, 202, 203, 157, 11, 153,
2, 17, 50, 66, 49, 84, 81, 1, 147, 161, 219, 219, 172, 139,

65, 202, 66,
24, 40, 33, 51, 50, 67, 115, 50, 19, 18, 170, 190, 190, 203,
170, 136, 72, 72, 56, 1, 131, 36, 98, 49, 18, 128, 170, 191,
173, 187, 152, 8, 49, 49, 67, 32, 148, 21, 50, 51, 5, 42,
240, 170, 173, 171, 138, 168, 3, 19, 21, 35, 35, 21, 115, 24,
148, 8, 217, 201, 201, 170, 153, 24, 130, 22, 16, 131, 72, 130,
39, 50, 179, 2, 207, 201, 171, 169, 16, 64, 3, 35, 136, 180,
74, 128, 70, 80, 130, 0, 188, 219, 172, 168, 32, 32, 20, 18,
129, 136, 138, 41, 114, 52, 133, 3, 156, 219, 187, 187, 136, 48,
52, 51, 49, 177, 144, 155, 89, 115, 115, 1, 179, 9, 175, 218,
137, 9, 1, 50, 33, 2, 0, 138, 152, 50, 84, 84, 2, 163,
185, 175, 173, 170, 153, 17, 65, 35, 51, 56, 153, 153, 176, 52,
113, 38, 48, 9, 235, 202, 156, 156, 136, 17, 50, 35, 36, 40,
176, 152, 27, 32, 54, 53, 33, 178, 202, 222, 186, 187, 137, 32,
66, 21, 35, 0, 177, 168, 10, 48, 114, 52, 133, 148, 128, 202,
172, 158, 170, 152, 17, 65, 35, 20, 17, 138, 216, 128, 41, 65,
52, 82, 16, 161, 185, 191, 235, 170, 137, 41, 48, 68, 33, 2,
144, 192, 136, 75, 40, 36, 53, 65, 128, 177, 202, 159, 158, 153,
137, 40, 33, 20, 35, 16, 177, 160, 13, 10, 18, 38, 37, 34,

15, 43, 60,
129, 155, 190, 204, 171, 156, 152, 2, 36, 67, 34, 18, 136, 202,
176, 137, 40, 38, 69, 81, 40, 152, 225, 185, 219, 186, 153, 42,
56, 21, 21, 49, 16, 152, 136, 12, 138, 161, 5, 68, 96, 16,
128, 160, 219, 188, 157, 155, 136, 32, 67, 36, 20, 1, 144, 153,
170, 169, 24, 97, 83, 36, 19, 16, 171, 249, 220, 155, 156, 136,
32, 81, 34, 19, 130, 136, 155, 187, 153, 57, 112, 83, 51, 20,
34, 9, 219, 251, 202, 156, 154, 9, 48, 82, 51, 35, 129, 192,
200, 153, 10, 41, 51, 39, 67, 34, 17, 128, 186, 222, 235, 202,
169, 9, 16, 67, 67, 34, 2, 161, 185, 140, 140, 128, 50, 68,
51, 21, 34, 26, 170, 250, 204, 172, 156, 138, 0, 50, 68, 35,
18, 128, 168, 217, 184, 24, 88, 49, 20, 36, 34, 128, 194, 176,
190, 191, 219, 169, 136, 17, 82, 51, 66, 16, 152, 168, 155, 139,
0, 99, 97, 33, 3, 2, 0, 169, 248, 173, 174, 202, 168, 24,
48, 67, 37, 33, 0, 168, 184, 170, 154, 2, 69, 81, 33, 18,
1, 177, 210, 216, 173, 159, 170, 168, 0, 49, 52, 21, 19, 0,
168, 185, 170, 139, 17, 38, 83, 50, 18, 131, 128, 184, 251, 207,
156, 171, 153, 0, 82, 66, 19, 4, 0, 10, 186, 184, 136, 40,
36, 22, 50, 34, 3, 18, 42, 191, 207, 172, 187, 169, 0, 67,

184, 225, 61,
37, 35, 1, 144, 169, 171, 187, 9, 67, 84, 51, 37, 34, 17,
144, 168, 239, 204, 186, 154, 10, 33, 68, 51, 51, 33, 137, 186,
219, 169, 8, 49, 53, 52, 98, 16, 128, 129, 0, 219, 207, 203,
186, 153, 40, 65, 83, 50, 18, 130, 136, 155, 219, 168, 40, 66,
52, 67, 34, 17, 0, 8, 9, 255, 205, 201, 153, 9, 40, 51,
37, 35, 19, 145, 184, 140, 141, 137, 0, 50, 67, 51, 50, 33,
2, 196, 219, 223, 187, 186, 154, 25, 67, 53, 66, 35, 1, 144,
186, 172, 155, 136, 66, 83, 20, 19, 33, 33, 32, 217, 253, 203,
187, 186, 153, 49, 84, 66, 50, 18, 129, 176, 201, 170, 155, 10,
66, 68, 67, 33, 19, 51, 144, 252, 236, 186, 155, 139, 9, 35,
38, 36, 18, 18, 16, 138, 218, 170, 153, 8, 66, 83, 50, 67,
65, 128, 211, 232, 173, 172, 154, 138, 0, 51, 53, 67, 33, 17,
161, 192, 169, 171, 12, 41, 81, 51, 21, 35, 82, 16, 184, 253,
203, 170, 154, 137, 40, 51, 38, 51, 34, 18, 0, 170, 188, 218,
153, 17, 82, 66, 35, 51, 50, 132, 250, 189, 189, 171, 170, 137,
33, 68, 67, 50, 19, 2, 161, 153, 158, 154, 136, 18, 52, 99,
50, 52, 18, 218, 221, 218, 185, 169, 137, 40, 67, 67, 35, 35,
18, 128, 171, 186, 202, 169, 50, 53, 82, 52, 52, 2, 225, 172,

183, 4, 57,
220, 171, 139, 25, 32, 52, 37, 20, 33, 16, 8, 185, 201, 168,
16, 65, 83, 67, 34, 18, 193, 221, 204, 202, 170, 137, 16, 34,
53, 51, 34, 34, 128, 168, 186, 156, 136, 2, 83, 68, 67, 50,
129, 251, 204, 188, 203, 170, 128, 34, 83, 67, 34, 17, 0, 0,
152, 170, 139, 24, 51, 115, 84, 35, 8, 168, 252, 204, 187, 171,
8, 16, 67, 37, 35, 34, 17, 8, 153, 185, 155, 40, 67, 68,
84, 34, 2, 184, 223, 203, 187, 187, 9, 33, 67, 53, 35, 34,
1, 128, 137, 169, 153, 32, 98, 83, 67, 35, 18, 192, 207, 204,
171, 171, 137, 16, 66, 67, 51, 36, 17, 129, 152, 153, 137, 25,
68, 37, 33, 21, 145, 188, 221, 203, 171, 170, 137, 33, 51, 53,
37, 18, 18, 129, 136, 153, 137, 66, 84, 67, 17, 144, 176, 207,
204, 171, 155, 154, 136, 66, 68, 35, 35, 18, 0, 0, 168, 154,
24, 114, 34, 3, 66, 129, 248, 190, 219, 171, 171, 152, 40, 83,
52, 36, 35, 17, 128, 168, 170, 154, 8, 33, 38, 33, 66, 147,
235, 205, 219, 171, 154, 137, 0, 82, 67, 51, 52, 50, 18, 152,
202, 172, 170, 136, 32, 34, 128, 16, 219, 173, 235, 203, 154, 1,
0, 18, 82, 52, 52, 49, 35, 130, 170, 186, 191, 153, 152, 137,
9, 177, 233, 203, 202, 152, 137, 17, 100, 68, 34, 19, 18, 145,

220, 3, 32,
202, 202, 173, 170, 187, 10, 16, 50, 70, 51, 51, 20, 170, 188,
203, 175, 90, 130, 0, 1, 129, 0, 152, 161, 136, 184, 129, 0,
160, 146, 128, 2, 98, 130, 1, 189, 165, 138, 152, 128, 161, 8,
11, 255, 128, 136, 128, 152, 176, 146, 98, 128, 52, 148, 18, 66,
36, 50, 34, 140, 201, 174, 188, 219, 155, 32, 89, 146, 49, 1,
35, 179, 154, 28, 134, 50, 59, 23, 67, 17, 176, 209, 219, 202,
157, 138, 128, 17, 65, 65, 49, 3, 146, 152, 173, 188, 153, 0,
65, 96, 50, 37, 34, 161, 201, 173, 188, 186, 153, 146, 51, 65,
66, 35, 146, 185, 158, 187, 218, 144, 18, 82, 67, 35, 22, 34,
154, 170, 174, 185, 171, 10, 144, 6, 25, 136, 4, 0, 186, 152,
160, 48, 227, 37, 98, 35, 129, 128, 154, 172, 186, 172, 154, 169,
0, 25, 185, 48, 4, 49, 115, 130, 129, 1, 162, 17, 178, 240,
8, 8, 8, 8, 9, 0, 0, 0, 0, 0, 0};

static int8_t  index = 0;	//willow add
static int32_t predsample = 0;

uint8_t ADPCM_Decode(uint8_t xcode)
{
  uint16_t step=0;
  int32_t diffq=0;
  
  step = StepSizeTable[index];

  /* 2. inverse code into diff */
  diffq = step>> 3;
  if (xcode&4)
  {
    diffq += step;
  }
  
  if (xcode&2)
  {
    diffq += step>>1;
  }
  
  if (xcode&1)
  {
    diffq += step>>2;
  }

  /* 3. add diff to predicted sample*/
  if (xcode&8)
  {
    predsample -= diffq;
  }
  else
  {
    predsample += diffq;
  }
  
  /* check for overflow*/
  if (predsample > 32767)
  {
    predsample = 32767;
  }
  else if (predsample < -32768)
  {
    predsample = -32768;
  }

  /* 4. find new quantizer step size */
  index += IndexTable [xcode];
  /* check for overflow*/
  if (index < 0)
  {
    index = 0;
  }
  else if (index > 88)
  {
    index = 88;
  }
  
  /* 6. return new speech sample*/
  return (uint8_t)((predsample/256)+128);
}

void pwm_init(void)
{
  P_SW2 = 0x80;
  PWM1_CCER1 = 0x00;
  PWM1_CCMR2 = 0x60;
  PWM1_CCER1 = 0x10;
  PWM1_CCR2H = 0x00;
  PWM1_CCR2L = 0x80;
  PWM1_ARRH  = 0x01;
  PWM1_ARRL  = 0x00;
  PWM1_ENO   = 0x04;
  PWM1_BKR   = 0x80;
  PWM1_CR1   = 0x01;
}

void PWM2_Interrupt(void) interrupt (27)
{
    PWM2_SR1 = 0x00;
    if(dac_read != dac_write)
    {
        PWM1_CCR2L = dac_buff1[dac_read++];
    }
    else
    {
        dac_read = 0;
        dac_write = 0;
        dac_sendflag = 0;
        PWM1_CCR2L = 0x80;  //保持中值
        PWM2_CR1 = 0x00;    //停止发送
        PWM2_IER = 0x00;
    }
}

uint8_t dac_send(void)
{
    static uint16_t i = 0;

    while((dac_write != (uint8_t)(dac_read-1)) && (dac_write != (uint8_t)(dac_read-2)))   //还有缓存空间则继续解码数据
    {
        if((i % 255) == 0)    //块数据头,每块255个字节
        {
            int16_t *p = (int16_t *)&wav_buf[i];  //16位音频数据
            predsample = *p;
            i+=2;
            dac_buff1[dac_write] = (predsample/256)+128;  //转换为8bit
            printf_byte(dac_buff1[dac_write]);            //串口输出音频数据
            dac_write++;

            index = wav_buf[i++];
        }
        else
        {
            dac_buff1[dac_write] = ADPCM_Decode(wav_buf[i]&0x0f);
            printf_byte(dac_buff1[dac_write]);
            dac_write++;
            dac_buff1[dac_write] = ADPCM_Decode(wav_buf[i]>>4);
            printf_byte(dac_buff1[dac_write]);
            dac_write++;
            i++;
            if(i == (uint16_t)sizeof(wav_buf))  //解码结束
            {
                i = 0;
                index = 0;
                predsample = 0;
                return 0;
            }
        }
    }

    if(dac_sendflag == 0)
    {
        PWM2_CNTRH = 0x00;
        PWM2_CNTRL = 0x00;

        PWM2_ARRH = 0x0A;
        PWM2_ARRL = 0xCD;

        PWM2_SR1 = 0x00;
        PWM2_IER = 0x01;
        PWM2_CR1 = 0x01;
        dac_sendflag = 1;
    }
    return 1;
}
